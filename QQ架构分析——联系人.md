# QQ架构分析——联系人

观察研究发现，QQ联系人大致可以分为4个模块，分别为：QQ好友UI结构及搜索，QQ群、设备、通讯录、公众号结构，QQ新朋友和可能认识的人，QQ创建群聊。下面将对这几个模块做简单分析。

## QQ好友UI结构分析

点开QQ联系人默认展示就是QQ好友界面，这一整个模块也算是QQ联系人比较核心的模块了，大多数情况下会显示成如下样式：

![QQ好友](http://onmw6wg88.bkt.clouddn.com/561519613950_.pic.jpg)

简要分析暂不考虑导航栏部分，对于上面这样一个界面的UI部分大致可以分为两个部分，如下图：

![QQ好友UI划分](http://onmw6wg88.bkt.clouddn.com/QQ%E5%A5%BD%E5%8F%8B%E7%BB%93%E6%9E%84%E5%88%92%E5%88%86.jpg)

整体界面是基于tableView的Plain样式设计，第一部分属于tableView的头部，这个头部也是一个tableView来的，上面说过这种样式只是一个大部分的情况，还有一些时候（比如有新朋友提醒）这里不作过多分析，只是头部展示不同。第一部分里第一行固定是 `搜索栏`，下面 `新朋友` 和 `创建群聊` 样式统一，比较简单，不加赘述。

重点是第二部分，整体的这个tableView其实就一个cell，也就是这个第二部分一整块，最上面的Segment部分作为SectionHeader存在，接着下面的一个cell就是 `collectionViewController➕tableViewController` 的组合了,既可以左右滑动，又可以上下滑动。同时，通过事件控制使上面的Segment跟随。这里还有一点就是tableView的折叠/展开，像上面这个图上我们看到的第二部分里每一行并不是tableView的cell，而是tableView每个Section的HeaderView，具体实现折叠/展开的方案如下：

> * tableView使用Plain样式，根据用户设置的分组数加上默认分组作为tableView的组数；
> * 自定义tableView的sectionHeaderView，使其展示成图中的样式，当然这里自定义的方式不止一种，可以使用普通 `view➕tap手势` 实现，也可以直接使用自定义 `Button` 的形式，这里我个人偏向于自定义Button的形式，Button自身就带有了一个 `ImageView` 和 `Label` 我们就只需要再为其添加一个 `Label` ，然后重写它的布局 `Layout` 即可，同时也具备了点击事件，并且易于区分事件；
> * 通过上面自定义sectionHeaderView的点击事件记录一个BOOL值，从而控制tableView的 `numberOfRowsInSection` 并通过 `reloadSections` 来达到折叠/展开的效果；

通过上述方案基本能够完成该页面的效果了，再加以细节调整优化便能达到较为理想的效果。

## QQ群、设备、通讯录、公众号结构分析

由于群聊、设备、通讯录以及公众号这几个模块相对比较简单，再加上有上面的好友模块作为铺垫，所以这里做统一分析。

1. 群聊

    最新的QQ把用户创建的群和用户加入的群分开展示了，如下图：
    
    ![QQ群聊](http://onmw6wg88.bkt.clouddn.com/571519628606_.pic.jpg)
    
    值得注意的是这里有的群，头像就是一张图片，而有的 `群` ,头像则是多个群成员头像组成的。这里就要说到QQ的讨论组了，由多个成员头像组成的这种其实并不是真正意义上的QQ群，而是一个QQ讨论组，但是QQ并没有直观上的去区分二者，仅是通过简单的头像做了区别。QQ讨论组头像共有如下几种：
    
    ![QQ讨论组头像](http://onmw6wg88.bkt.clouddn.com/11121.png)
    
    最多展示讨论组中前5个人的头像，按照一定的角度旋转、裁剪、拼接构成。下面将针对两个人的时候头像构成方式作出说明，其他情况请自行参阅：[QQ讨论组头像的实现](https://github.com/itlijunjie/QQHeader)
    
    假设我们需要的头像大小为边长 `L` 的正方形图片，则我们需要计算出两个人的时候每个人的头像大小及其在正方形图片中的位置，请看下图：
    
    ![头像大小计算](http://onmw6wg88.bkt.clouddn.com/22551519634791_.pic.jpg)
    
    通过上图的计算我们可以看到每个头像的大小应当是正方形图片边长的 `2-√2` 倍，接着我们需要计算出每个头像的位置，请看下图：
    
    ![头像位置计算](http://onmw6wg88.bkt.clouddn.com/591519637595_.pic_hd.jpg)
    
    通过上图就可以很清晰的看到两个头像在我们需要的正方形里要如何布局了，这里描述的是两个头像相切的情况，实际上展示的时候还需要对其进行必要的裁剪，这里不作过多叙述。经过详细计算后将每个头像通过 `Layer` 绘制到一个空白的 `View` 上再转换成图片即可得到我们想要的效果了。

2. 设备

    设备部分主要是用于多端登录的时候方便资料同步及文件传输，并且新版的QQ上还有 `发现新设备` 功能，这一部分涉及到的功能比较多，已经脱离联系人模块，不作详细分析。

3. 通讯录

    通讯录模块是QQ通过读取手机通讯录并检测是否绑定QQ账号，从而识别好友，推荐好友等功能，主要是通讯录展示和匹配QQ号，展示方式也比较简单，QQ号匹配主要依赖服务端实现。

4. 公众号

    公众号部分主要是QQ系统服务号和一些使用过的商家公众号的展示，展示的时候涉及到将 `title` 做汉字转拼音字母再进行排序展示，如下图：
    
    ![QQ公众号](http://onmw6wg88.bkt.clouddn.com/601519639369_.pic.jpg)
    
    这个不算复杂，网上的例子也比较多，这里就不详细解释了。

## QQ新朋友和可能认识的人分析

首先是新朋友部分，QQ新朋友主要是用于处理好友添加请求，包括自己加别人发送的添加好友请求和别人添加你的时候发送过来的添加好友请求，展示方面比较简单，如下图：

![QQ新朋友](http://onmw6wg88.bkt.clouddn.com/611519639752_.pic.jpg)

新朋友部分做基本的数据处理展示就可以了，这里还有一个可能认识的人，这也是最开始说QQ好友的时候说了大部分时候的情况，那么这个可能认识的人就是那一小部分，QQ通过对好友关系的分析，数据的比对等等（当然，具体细节不详），会推送一些可能熟悉的人给你，并提供快捷添加好友按钮。

## QQ创建群聊

QQ为创建群聊提供了两种方式，分别是 `选人创建` 和 `按分类创建` 如下图：

![QQ创建群](http://onmw6wg88.bkt.clouddn.com/641519640793_.pic_hd.jpg)

其中 `选人创建` 与QQ好友部分的界面基本可以复用，就多了一个面对面建群，而这个面对面建群的实现主要还是依赖服务端长链接消息推送，将一定时间内输入相同密码的用户推送到一起，与选人建群不同的是这并不要求一定具备好友关系。

而 `按分类创建` 则是选择一个类别后就会在将创建的群附带上一些标签信息，填写一些群信息，采用先建群后加人的方式。

这两种群组创建的基本形式和 `MobIM` 中采用的方式类似，基本都是采用HTTP形式与服务器交互。

## 总结

首先，要说的是上面所有操作都基于本地数据缓存，数据库操作的基础上，其次是HTTP交互与Socket消息处理的配合，实时通知并刷新。总的来说，QQ联系人这一块的细节处理还是比较多的，逻辑复杂度不算是很高，算是设计比较经典的联系人模块了。


